# main.py
import json
import os
from datetime import datetime
from figma_client import FigmaClient
from deep_analyzer import DeepFigmaAnalyzer
from smart_prompt_generator import SmartPromptGenerator
from frame_splitter import FrameSplitter
from config import Config

def main():
    """
    –ì–õ–ê–í–ù–´–ô –°–ö–†–ò–ü–¢ –°–ò–°–¢–ï–ú–´ FIGMA-TO-CODE
    –ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã
    """
    print("üöÄ –ó–∞–ø—É—Å–∫ Figma-to-Code —Å–∏—Å—Ç–µ–º—ã —Å –†–û–î–ò–¢–ï–õ–¨–°–ö–ò–ú–ò –§–†–ï–ô–ú–ê–ú–ò...")
    print(f"üìÅ File Key: {Config.FIGMA_FILE_KEY}")
    print(f"üéØ Target Node: {Config.FIGMA_NODE_ID}")
    
    # –°–æ–∑–¥–∞–µ–º –≤—ã—Ö–æ–¥–Ω—É—é –ø–∞–ø–∫—É –µ—Å–ª–∏ –µ–µ –Ω–µ—Ç
    os.makedirs(Config.OUTPUT_DIR, exist_ok=True)
    
    # –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–û–ú–ü–û–ù–ï–ù–¢–û–í –°–ò–°–¢–ï–ú–´
    # –ö–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–≤–æ—é —á–∞—Å—Ç—å —Ä–∞–±–æ—Ç—ã:
    figma_client = FigmaClient()           # üì° –†–∞–±–æ—Ç–∞ —Å Figma API
    deep_analyzer = DeepFigmaAnalyzer()    # üîç –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã Figma
    smart_generator = SmartPromptGenerator()  # üß† –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è –ò–ò
    frame_splitter = FrameSplitter()       # ‚úÇÔ∏è –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ñ—Ä–µ–π–º—ã
    
    try:
        # –≠–¢–ê–ü 1: üì° –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• –ò–ó FIGMA
        print("\nüìç –≠–¢–ê–ü 1: –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Figma API...")
        figma_data = figma_client.get_full_structure()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã
        if not figma_data.get("full_file"):
            print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Figma API")
            print("   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ FIGMA_ACCESS_TOKEN –∏ FIGMA_FILE_KEY –≤ .env —Ñ–∞–π–ª–µ")
            return
        
        print("‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã –∏–∑ Figma")
        
        # –≠–¢–ê–ü 2: üîç –ü–û–õ–ù–´–ô –ê–ù–ê–õ–ò–ó –°–¢–†–£–ö–¢–£–†–´ FIGMA
        print("\nüìç –≠–¢–ê–ü 2: –í—ã–ø–æ–ª–Ω—è–µ–º –ü–û–õ–ù–´–ô –∞–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã...")
        complete_analysis = deep_analyzer.analyze_completely(figma_data)
        
        # –≠–¢–ê–ü 3: ‚úÇÔ∏è –†–ê–ó–î–ï–õ–ï–ù–ò–ï –ù–ê –†–û–î–ò–¢–ï–õ–¨–°–ö–ò–ï –§–†–ï–ô–ú–´ –ü–ï–†–í–û–ì–û –£–†–û–í–ù–Ø
        print("\nüìç –≠–¢–ê–ü 3: –†–∞–∑–¥–µ–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—Ä–µ–π–º—ã –ø–µ—Ä–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è...")
        frames_data = frame_splitter.split_into_frames(complete_analysis)
        
        # –≠–¢–ê–ü 4: üß† –ì–ï–ù–ï–†–ê–¶–ò–Ø –£–ú–ù–´–• –ü–†–û–ú–ü–¢–û–í –î–õ–Ø –ö–ê–ñ–î–û–ì–û –§–†–ï–ô–ú–ê
        print("\nüìç –≠–¢–ê–ü 4: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –£–ú–ù–´–ï –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ—Ä–µ–π–º–∞...")
        smart_generator.generate_smart_prompts(complete_analysis, frames_data)
        
        # –í–´–í–û–î –°–¢–ê–¢–ò–°–¢–ò–ö–ò –ò –†–ï–ó–£–õ–¨–¢–ê–¢–û–í
        stats = complete_analysis["statistics"]
        print(f"\nüìä –ü–û–õ–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:")
        print(f"   - –í—Å–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤: {stats['total_elements']}")
        print(f"   - –£—Ä–æ–≤–Ω–µ–π –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏: {stats['max_depth']}")
        print(f"   - –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–∏–ø–æ–≤: {len(stats['type_counts'])}")
        print(f"   - –í—Å–µ–≥–æ —Ñ—Ä–µ–π–º–æ–≤: {frames_data['total_frames']}")
        print(f"   - –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ—Ä–µ–π–º–æ–≤: {len(frames_data['parent_frames'])}")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫–∏–µ —Ç–∏–ø—ã —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–∞–π–¥–µ–Ω—ã
        print(f"   - –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º:")
        for elem_type, count in stats['type_counts'].items():
            print(f"     ‚Ä¢ {elem_type}: {count}")
        
        print(f"\nüéØ –°–ò–°–¢–ï–ú–ê –†–ê–ó–î–ï–õ–ï–ù–ê –ù–ê –†–û–î–ò–¢–ï–õ–¨–°–ö–ò–ï –§–†–ï–ô–ú–´!")
        print(f"üìÇ –ü–∞–ø–∫–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏: {Config.OUTPUT_DIR}/")
        
        print(f"\nüìã –°–¢–†–£–ö–¢–£–†–ê –í–´–•–û–î–ù–´–• –§–ê–ô–õ–û–í:")
        print(f"   üìÑ frames/root_frame.json - –ö–æ—Ä–Ω–µ–≤–æ–π —Ñ—Ä–µ–π–º (–≤–µ—Å—å –º–∞–∫–µ—Ç)")
        print(f"   üìÅ frames/ - –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—Ä–µ–π–º—ã ({len(frames_data['parent_frames'])} —à—Ç)")
        print(f"   üìÑ frames_metadata.json - –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ñ—Ä–µ–π–º–æ–≤")
        print(f"   üìÑ FRAMES_INDEX.md - –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ñ—Ä–µ–π–º–∞–º")
        print(f"   üìÅ smart_prompts/ - –£–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è –ò–ò")
        print(f"   üìÑ complete_analysis_full.json - –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)")
        
        print(f"\nüí° –ö–õ–Æ–ß–ï–í–´–ï –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê –°–ò–°–¢–ï–ú–´:")
        print(f"   ‚úÖ –¢–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–µ–∫—Ü–∏–∏ –º–∞–∫–µ—Ç–∞ ({len(frames_data['parent_frames'])} —Ñ—Ä–µ–π–º–æ–≤)")
        print(f"   ‚úÖ –ö–∞–∂–¥—ã–π —Ñ—Ä–µ–π–º —Å–æ–¥–µ—Ä–∂–∏—Ç –ü–û–õ–ù–£–Æ –í–õ–û–ñ–ï–ù–ù–û–°–¢–¨ —Å–≤–æ–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤")
        print(f"   ‚úÖ –õ–æ–≥–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —É–ø—Ä–∞–≤–ª—è–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤")
        print(f"   ‚úÖ –ú–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–∞–∂–¥—É—é —Å–µ–∫—Ü–∏—é —Ü–µ–ª–∏–∫–æ–º –ø–æ –æ–¥–Ω–æ–º—É –ø—Ä–æ–º–ø—Ç—É")
        
        print(f"\nüöÄ –°–û–í–ï–¢ –ü–û –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ:")
        print(f"   1. –ù–∞—á–Ω–∏ —Å smart_prompts/root_frame_prompt.txt")
        print(f"   2. –ó–∞—Ç–µ–º —Ä–µ–∞–ª–∏–∑—É–π —Å–µ–∫—Ü–∏–∏ –∏–∑ smart_prompts/parent_frames/")
        print(f"   3. –ö–∞–∂–¥—ã–π –ø—Ä–æ–º–ø—Ç —Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω - —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–µ–∫—Ü–∏–∏")
        print(f"   4. –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π –≥–æ—Ç–æ–≤—ã–µ —Å–µ–∫—Ü–∏–∏ –≤ –∫–æ—Ä–Ω–µ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ—Ä–µ–π–º–æ–≤ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        if frames_data['parent_frames']:
            print(f"\nüìã –°–ü–ò–°–û–ö –†–û–î–ò–¢–ï–õ–¨–°–ö–ò–• –§–†–ï–ô–ú–û–í:")
            for i, frame in enumerate(frames_data['parent_frames'][:10]):  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 10
                print(f"   {i+1}. {frame['name']} ({frame['total_elements']} —ç–ª–µ–º–µ–Ω—Ç–æ–≤)")
            if len(frames_data['parent_frames']) > 10:
                print(f"   ... –∏ –µ—â–µ {len(frames_data['parent_frames']) - 10} —Ñ—Ä–µ–π–º–æ–≤")
        
        print(f"\n‚è±Ô∏è  –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–µ–Ω –≤: {datetime.now().strftime('%H:%M:%S')}")
        print(f"üéâ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ! –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ–º–ø—Ç—ã –∏–∑ –ø–∞–ø–∫–∏ smart_prompts/")
        
    except Exception as e:
        # –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö
        print(f"üí• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: {str(e)}")
        print("üîç –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:")
        import traceback
        traceback.print_exc()  # –ü–µ—á–∞—Ç–∞–µ–º –ø–æ–ª–Ω—ã–π traceback –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

# –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ - —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–∑–≤–∞–Ω –Ω–∞–ø—Ä—è–º—É—é
if __name__ == "__main__":
    main()